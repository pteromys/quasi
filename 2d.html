<!doctype html>
<html lang="en">
<head>
	<title>Quasicrystals</title>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" type="text/css" href="icons/webfont.css" />
	<link rel="stylesheet" type="text/css" href="interface.css" />
	<style type="text/css">
		html, body { width: 100%; height: 100%; margin: 0px; padding: 0px; }
		body { background: #000; }
		canvas {
			position: absolute;
			top: 0px; left: 0px;
			opacity: 0;
			z-index: 1;
			transition: opacity 10s 0.2s;
			-webkit-transition: opacity 10s 0.2s;
		}
		canvas.active {
			opacity: 1;
			z-index: 0;
			transition: opacity 0s 0s;
			-webkit-transition: opacity 0s 0s;
		}
		#canvascontainer {
			position: absolute;
			top: 0px; bottom: 0px; left: 0px; right: 0px;
			overflow: hidden;
		}
		#config .box { text-align: center; }
		.formline { margin: 0.5em -1em 0em; }
		.formline .button { margin: 0em 0.25em; }
	</style>
	<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
	<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
	<script type="text/javascript" src="heap.js"></script>
	<script type="text/javascript" src="motion.js"></script>
	<script type="text/javascript" src="frames.js"></script>
	<script type="text/javascript" src="interface.js"></script>
	<script type="text/javascript">
		var fillCircle = function (context, x, y, r) {
			context.beginPath();
			context.arc(x, y, r, 0, Math.PI*2, true);
			context.fill();
		};
		var DEGREE_LIMIT = 23;
		var BLIT_LIMIT = 100;
		var renderData = function (data, canvas) {
			// Set up context
			var context = canvas.getContext('2d');
			context.save();
			var gradient = context.createRadialGradient(0, 0, 0, 0, 0, 1);
			gradient.addColorStop(0, '#fff');
			gradient.addColorStop(0.5, '#ff0');
			gradient.addColorStop(1, '#000');
			var r = canvas.width / 3;
			context.fillStyle = gradient;
			context.globalCompositeOperation = 'lighter';
			context.translate(canvas.width/2, canvas.height/2);
			var scale = r / window.options.r;
			context.scale(scale, -scale);
			var j = 0;
			for (var i = window.current_data_index; i < data.length && j < BLIT_LIMIT; i++, j++) {
				context.save();
				context.translate(data[i], data[i+1]);
				i += 2;
				context.scale(data[i], data[i]);
				context.fillRect(-1, -1, 2, 2);
				context.restore();
			}
			window.current_data_index = i;
			context.restore();
			return i < data.length;
		};
		var swapBuffers = function () {
			$('canvas').toggleClass('active');
		}
		var resetActiveBuffer = function () {
			$('canvas.active').prop({
				width: 3 * window.screen_radius,
				height: 3 * window.screen_radius,
			});
		};
		var resetZoom = function () {
			$('meta[name="viewport"]').attr('content', 'width=device-width, initial-scale=1');
		};
		window.tracker = {
			num_verts: 0,
			next_weight: 0,
			threshold_weight: Infinity,
			num_visible: 0,
			num_seen: 0,
		};
		window.current_n = 5;
		window.current_data = [];
		window.current_data_index = 0;
		window.done_threshold = 0;
		window.offsets = {one: [0, 0], two: [0, 0]};
		window.screen_radius = 1000;
		window.options = {n: 5, r: 5};
		$(document).ready(function () {
			var t_0 = null;
			window.movable = new Movable();
			movable.canAccelerate = function () {
				return !($('.overlay').is(':target'));
			};
			movable.bindHandlers(window);
			movable.scaled_position = [0, 0];
			movable.moveReset = function () {
				this.position[0] = this.position[1] = 0;
				this.velocity[0] = this.velocity[1] = 0;
				window.renderWorker.postMessage({type: 'moveReset'});
			};
			window.renderWorker = new Worker('projector.js');
			window.renderWorker.onmessage = function (e) {
				var data = e.data;
				if (data.type == '') {
				} else if (data.type == 'render') {
				var active_ready = (window.current_data_index >= window.current_data.length || window.current_data_index >= window.done_threshold);
					window.current_data = data.points;
					window.done_threshold = window.current_data_index + 3 * BLIT_LIMIT;
					window.current_data_index = 0;
					if (active_ready) { swapBuffers(); }
					resetActiveBuffer();
					window.offsets[$('canvas.active').prop('id')] = data.offset;
					window.sprite_manager.requestFrame();
				} else if (data.type == 'vertRequest') {
					this.postMessage({type: 'addVerts'});
				} else if (data.type == 'translationDone') {
					translation_in_progress = false;
					if (translation_queued) {
						translation_queued = false;
						window.reTranslate();
					}
				} else {
					// Show a message box...
				}
			};
			window.replaceLattice = function (n, radius) {
				window.current_n = n;
				window.renderWorker.postMessage({
					type: 'setSymmetry',
					"n": n,
				});
				window.renderWorker.postMessage({type: 'addVerts'});
				window.movable.moveReset();
				//movable.scaled_position[0] = movable.scaled_position[1] = 0;
				resetZoom();
				resizeTotal();
			};
			window.translation_in_progress = false;
			window.translation_queued = false;
			window.reTranslate = function () {
				if (!translation_in_progress) {
					window.renderWorker.postMessage({
						type: 'reTranslate',
						xy: movable.scaled_position,
					});
					translation_in_progress = true;
				} else {
					translation_queued = true;
				}
			};
			var fillCanvas = function () {
				var ans = renderData(window.current_data, $('canvas.active')[0]);
				window.frame_manager.requestFrame();
				return ans;
			};
			window.sprite_manager = new FrameManager(fillCanvas);
			var draw = function () {
				var draw_again = false;
				// Keyboard and mouse motion
				movable.update(this.dt);
				if (movable.isMoving()) { draw_again = true; }
				// Draw
				var scale = window.screen_radius / window.options.r;
				$('canvas').each(function (i, canvas) {
					$(canvas).css({
						width: 3 * window.screen_radius,
						height: 3 * window.screen_radius,
					});
					var transform = [
						-movable.position[0] + scale * window.offsets[canvas.id][0] -
							$(canvas).width()/2 + $('#canvascontainer').width()/2,
						-movable.position[1] - scale * window.offsets[canvas.id][1] -
							$(canvas).height()/2 + $('#canvascontainer').height()/2,
					];
					transform = 'translate(' + transform[0] + 'px, ' + transform[1] + 'px)';
					$(canvas).css({
						"transform": transform,
						"-moz-transform": transform,
						"-webkit-transform": transform,
					});
				});
				// Translate
				window.reTranslate();
				// Update tracker
				$('#worst').text(tracker.num_visible + '/' + tracker.num_seen + '/' + tracker.num_verts+ ' ' + tracker.next_weight + '/' + tracker.threshold_weight);
				// Return
				return draw_again;
			};
			window.frame_manager = new FrameManager(draw);
			var resizeTotal = function () {
				var r = window.screen_radius =
					Math.sqrt(window.innerWidth * window.innerWidth +
					window.innerHeight * window.innerHeight)/2;
				movable.v_walk = 0.0006 * r;
				movable.v_run = 0.0024 * r;
				resizeLocal();
				window.renderWorker.postMessage({
					type: 'setRadius',
					radius: r,
				});
			};
			var resizeLocal = function () {
				var r = window.screen_radius;
				// We flip the y axis because mathematicians like the y axis up
				// Then we flip both axes again to use position subtractively
				movable.scaled_position[0] = -movable.position[0] * window.options.r / r;
				movable.scaled_position[1] = movable.position[1] * window.options.r / r;
				if (window.options.n == 2) { movable.scaled_position[1] = 0; }
				window.frame_manager.requestFrame();
			};
			movable.motionCallback = resizeLocal;
			$(window).on('resize', resizeTotal);
			window.draw = draw;
			// Activate the form
			var replacement_form = new ActiveForm($('#form_config'));
			replacement_form.field_processors.n = function (field) {
				var ans = ActiveForm.numericProcessor(field);
				if (ans[0]) { return ans; }
				if (ans[1] < 2) { return [true, 'Enter a number at least 2.']; }
				if (ans[1] > DEGREE_LIMIT) { return [true,
					'Degrees higher than ' + DEGREE_LIMIT +' not supported.']; }
				return ans;
			};
			replacement_form.actions.push(function (e, data) {
				e.preventDefault();
				replaceLattice(data.n);
				window.location = '#';
			});
			// Set initial lattice
			replaceLattice(5);
		});
	</script>
</head>
<body>
	<div id="canvascontainer">
		<canvas id="one" class="active">
			<img src="quasi-thumbnail.png" alt="Preview" />
			This demo requires HTML5 Canvas support.
		</canvas>
		<canvas id="two"></canvas>
	</div>
	<div id="worst" style="position: absolute; z-index: 10; width: 100%; height: 1em; left:0px; top:0px; color: #fff;"></div>
	<div id="config" class="overlay"><div class="box">
		<h2>Choose symmetry</h2>
		<form method="post" action="#" id="form_config"><div class="formline">
			<a class="button icon button_close" title="Cancel" href="#">&times;</a>
			<label for="config_n" class="icon">&#x21ba;</label>
			<input type="text" class="numeric valid" id="config_n" name="n" value="5" />
			<button type="submit" class="button icon"
				id="config_submit" title="Redraw">&#x00bb;</button>
		</div></form>
	</div></div>
	<div id="help" class="overlay">
		<div class="box">
			<a class="button icon button_close button_rightmargin"
				title="Close" href="#">&times;</a>
			<p>This page draws patterns reminiscient of quasicrystals
			by projecting higher-dimensional lattices into the plane.
			<p>Code written by <a href="http://pteromys.melonisland.net/">Pteromys</a>
			and released under the <a href="http://unlicense.org/">Unlicense</a>.</p>
		</div>
	</div>
	<a class="button icon button_root"
		href="#help" id="button_help" title="Help">?</a>
	<a class="button icon button_root"
		href="#config" id="button_config" title="Settings">&#x2699;</a>
</body>
</html>
