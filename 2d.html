<!doctype html>
<html lang="en">
<head>
	<title>Quasicrystals</title>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" type="text/css" href="icons/webfont.css" />
	<link rel="stylesheet" type="text/css" href="interface.css" />
	<style type="text/css">
		html, body { width: 100%; height: 100%; margin: 0px; padding: 0px; }
		body { background: #000; }
		canvas { display: block; width: 100%; height: 100%; }
		#canvascontainer {
			position: absolute;
			top: 0px; bottom: 0px; left: 0px; right: 0px;
		}
		#config .box { text-align: center; }
		.formline { margin: 0.5em -1em 0em; }
		.formline .button { margin: 0em 0.25em; }
	</style>
	<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
	<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
	<script type="text/javascript" src="heap.js"></script>
	<script type="text/javascript" src="motion.js"></script>
	<script type="text/javascript" src="frames.js"></script>
	<script type="text/javascript" src="interface.js"></script>
	<script type="text/javascript">
		var fillCircle = function (context, x, y, r) {
			context.beginPath();
			context.arc(x, y, r, 0, Math.PI*2, true);
			context.fill();
		};
		var DEGREE_LIMIT = 23;
		var GRADIENT = undefined;
		var getGradient = function (context) {
			if (GRADIENT) { return GRADIENT; }
			this.gradient = context.createRadialGradient(0, 0, 0, 0, 0, 1);
			this.gradient.addColorStop(0, '#fff');
			this.gradient.addColorStop(0.5, '#ff0');
			this.gradient.addColorStop(1, '#000');
			return this.gradient;
		};
		var renderFromData = function (data, context, target_radius) {
			// Set up context
			var m = context.canvas;
			var w = context.canvas.width = $(window).width();
			var h = context.canvas.height = $(window).height();
			var r = Math.sqrt(w*w + h*h)/2;
			context = context.canvas.getContext('2d');
			context.fillStyle = getGradient(context);
			context.globalCompositeOperation = 'lighter';
			context.translate(context.canvas.width/2, context.canvas.height/2);
			var scale = r / target_radius;
			context.scale(scale, -scale);
			for (var i = 0; i < data.length; i++) {
				context.save();
				context.translate(data[i], data[i+1]);
				i += 2;
				context.scale(data[i], data[i]);
				context.fillRect(-1, -1, 2, 2);
				context.restore();
			}
		};
		window.tracker = {
			num_verts: 0,
			next_weight: 0,
			threshold_weight: Infinity,
			num_visible: 0,
			num_seen: 0,
		};
		window.current_data = [];
		window.options = {n: 5, r: 5};
		$(document).ready(function () {
			var m = document.getElementById('main');
			var t_0 = null;
			var offset = null;
			window.movable = new Movable();
			movable.canAccelerate = function () {
				return !($('.overlay').is(':target'));
			};
			movable.bindHandlers(window);
			movable.scaled_position = [0, 0];
			window.renderWorker = new Worker('projector.js');
			window.renderWorker.onmessage = function (e) {
				var data = e.data;
				if (data.type == '') {
				} else if (data.type == 'render') {
					window.current_data = data.points;
					frame_manager.requestFrame();
				} else if (data.type == 'vertRequest') {
					this.postMessage({type: 'addVerts'});
				} else {
					// Show a message box...
				}
			};
			window.replaceLattice = function (n, radius) {
				//window.q = new QuasiLattice(n, radius);
				window.renderWorker.postMessage({
					type: 'setSymmetry',
					"n": n,
				});
				window.renderWorker.postMessage({type: 'addVerts'});
				window.movable.moveReset();
				offset = new Int8Array(n);
				resizeAdjustment();
			};
			var draw = function () {
				var draw_again = false;
				// Keyboard and mouse motion
				movable.update(this.dt);
				//if (movable.isMoving()) { draw_again = true; }
				// Draw
				//q.draw(m.getContext('2d'), movable.scaled_position, offset, 1);
				renderFromData(window.current_data, m.getContext('2d'), 5);
				// Add verts
				// Translate
				/*var translator = q.verts[0];
				for (var i = 0; i < q.directions.length; i++) {
					if (cmpTranslators(translator, q.directions[i]) > 0) {
						translator = q.directions[i];
					}
				}
				offset = new Vertex(V.add(offset.indices, translator.indices), q);
				if (!V.isZero(translator.indices)) { draw_again = true; }*/
				// Update tracker
				$('#worst').text(tracker.num_visible + '/' + tracker.num_seen + '/' + tracker.num_verts+ ' ' + tracker.next_weight + '/' + tracker.threshold_weight);
				// Return
				return draw_again;
			};
			window.frame_manager = new FrameManager(draw);
			var resizeAdjustment = function () {
				var r = Math.sqrt(window.innerWidth * window.innerWidth +
					window.innerHeight * window.innerHeight)/2;
				// We flip the y axis because mathematicians like the y axis up
				// Then we flip both axes again to use position subtractively
				movable.scaled_position[0] = -movable.position[0] * window.options.r / r;
				movable.scaled_position[1] = movable.position[1] * window.options.r / r;
				if (window.options.n == 2) { movable.scaled_position[1] = 0; }
				movable.v_walk = 0.0006 * r;
				movable.v_run = 0.0024 * r;
				frame_manager.requestFrame();
			};
			movable.motionCallback = resizeAdjustment;
			$(window).on('resize', resizeAdjustment);
			window.draw = draw;
			// Activate the form
			var replacement_form = new ActiveForm($('#form_config'));
			replacement_form.field_processors.n = function (field) {
				var ans = ActiveForm.numericProcessor(field);
				if (ans[0]) { return ans; }
				if (ans[1] < 2) { return [true, 'Enter a number at least 2.']; }
				if (ans[1] > DEGREE_LIMIT) { return [true,
					'Degrees higher than ' + DEGREE_LIMIT +' not supported.']; }
				return ans;
			};
			replacement_form.actions.push(function (e, data) {
				e.preventDefault();
				replaceLattice(data.n);
				window.location = '#';
			});
			// Set initial lattice
			replaceLattice(5);
		});
	</script>
</head>
<body>
	<div id="canvascontainer">
		<canvas id="main">
			<img src="quasi-thumbnail.png" alt="Preview" />
			This demo requires HTML5 Canvas support.
		</canvas>
	</div>
	<div id="worst" style="position: absolute; z-index: 10; width: 100%; height: 1em; left:0px; top:0px; color: #fff;"></div>
	<div id="config" class="overlay"><div class="box">
		<h2>Choose symmetry</h2>
		<form method="post" action="#" id="form_config"><div class="formline">
			<a class="button icon button_close" title="Cancel" href="#">&times;</a>
			<label for="config_n" class="icon">&#x21ba;</label>
			<input type="text" class="numeric valid" id="config_n" name="n" value="5" />
			<button type="submit" class="button icon"
				id="config_submit" title="Redraw">&#x00bb;</button>
		</div></form>
	</div></div>
	<div id="help" class="overlay">
		<div class="box">
			<a class="button icon button_close button_rightmargin"
				title="Close" href="#">&times;</a>
			<p>This page draws patterns reminiscient of quasicrystals
			by projecting higher-dimensional lattices into the plane.
			<p>Code written by <a href="http://pteromys.melonisland.net/">Pteromys</a>
			and released under the <a href="http://unlicense.org/">Unlicense</a>.</p>
		</div>
	</div>
	<a class="button icon button_root"
		href="#help" id="button_help" title="Help">?</a>
	<a class="button icon button_root"
		href="#config" id="button_config" title="Settings">&#x2699;</a>
</body>
</html>
